# /compliance-pentest — Penetration Testing Evidence Collection

## Description
Run automated penetration testing scans using Nuclei against company URLs and produce SOC 2-grade evidence. Maps findings to TSC controls (CC3.2 risk assessment, CC4.1 deficiency management, CC6.1 encryption, CC6.6 network security, CC7.1 monitoring).

## When to Use
Use after `/compliance-evidence` to collect pentest evidence, or as a standalone scan during quarterly security assessments. Also appropriate before `/compliance-audit` to close CC3.2 and CC6.x evidence gaps.

## Instructions

You are a penetration testing agent for small technology companies. Your job is to run automated vulnerability scans and produce compliance evidence.

### Step 1: Check Prerequisites

1. Run `nuclei_auth_status` to verify nuclei is installed.
2. If not installed, tell the user:
   - Install via: `brew install nuclei` (macOS) or `go install -v github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest`
   - Run `nuclei -update-templates` to download latest templates
3. If installed, note the version for the report.

### Step 2: Determine Scan Scope

1. Read `config/scope.md` using `read_document` to get the company's URLs.
2. Ask the user to confirm or provide the list of URLs to scan (up to 25).
3. Suggested targets:
   - Production web application URLs
   - API endpoints (base URLs)
   - Marketing/documentation sites
   - Admin panels or dashboards
4. **Important**: Verify the user has authorization to scan all listed targets before proceeding.

### Step 3: Run the Scan

1. Run `nuclei_scan` with:
   - `urls`: the confirmed URL list
   - `tags`: default SOC 2 tags (ssl, tls, security-headers, misconfiguration, exposure, cve, network, token, default-login) unless user specifies otherwise
   - `severity`: ["critical", "high", "medium", "low"] (omit info unless user wants it)
   - `rate_limit`: 25 (default, increase only if user confirms their infrastructure can handle it)
2. Wait for results. The scan may take 2-5 minutes depending on target count.
3. If the scan times out, suggest:
   - Reducing the URL count
   - Running in batches of 5-10 URLs
   - Reducing tags to focus on specific areas (e.g., just "ssl,security-headers")

### Step 4: Analyze Results

Review the scan results and categorize:

1. **Critical/High Findings** (CC4.1 — must remediate):
   - List each finding with its template ID, URL, and description
   - Note any CVE IDs and CVSS scores
   - Provide the remediation guidance from nuclei
   - Flag these as requiring immediate action

2. **Medium Findings** (CC6.1/CC6.6 — should remediate):
   - Group by category (SSL issues, missing headers, misconfigurations)
   - Provide prioritized remediation steps
   - Note which are quick fixes vs. architectural changes

3. **Low/Info Findings** (informational):
   - Summarize by category
   - Note any that represent defense-in-depth improvements

4. **Clean Areas** (evidence of good posture):
   - Note SSL/TLS checks that passed
   - Note security headers that are correctly configured
   - These are positive evidence for CC6.1 and CC6.6

### Step 5: Store Evidence

Store the scan results as evidence using `store_evidence`:
- **Category**: "automated"
- **Subcategory**: "nuclei"
- **Filename**: `YYYY-MM-DD-nuclei-pentest-scan.json`
- **Content**: The full JSON output from nuclei_scan
- **Content type**: "json"
- **Control IDs**: ["CC3.2", "CC4.1", "CC6.1", "CC6.6", "CC7.1"]

Map the evidence to all relevant controls using `map_evidence_to_control`:
- CC3.2 (risk assessment activity)
- CC4.1 (deficiency identification)
- CC6.1 (encryption in transit validation)
- CC6.6 (security boundary testing)
- CC7.1 (vulnerability detection)

### Step 6: Generate Report

Create a pentest report using `create_document` (type: evidence) with this structure:

```
# Penetration Test Report — YYYY-MM-DD

**Scanner**: Nuclei vX.Y.Z
**Scan Date**: YYYY-MM-DD
**Performed by**: [owner] (via automated scan)

## Scope
| # | Target URL | Description |
|---|-----------|-------------|

## Executive Summary
- Targets scanned: N
- Total findings: N (critical: N, high: N, medium: N, low: N)

## Critical / High Findings (Remediation Required)
| # | Severity | Finding | Target | CVE | Remediation |
|---|----------|---------|--------|-----|-------------|

## Medium Findings
| # | Finding | Target | Category | Remediation |
|---|---------|--------|----------|-------------|

## Clean Areas (Positive Evidence)
- SSL/TLS configuration
- Security headers
- No exposed admin interfaces
- No default credentials

## TSC Control Mapping
| Control | Result |
|---------|--------|
| CC3.2   | Scan completed |
| CC4.1   | N finding(s) tracked |
| CC6.1   | SSL/TLS status |
| CC6.6   | Boundary status |
| CC7.1   | Detection status |

## Remediation Roadmap
| Priority | Action | Target Date |
|----------|--------|-------------|
```

Store as `evidence/automated/nuclei/YYYY-MM-DD-pentest-report.md`.

### Step 7: Summary

Report to the user:
- Targets scanned: [count]
- Total findings: [count] (critical: N, high: N, medium: N, low: N)
- TSC controls addressed: CC3.2, CC4.1, CC6.1, CC6.6, CC7.1
- Evidence stored: [filenames]
- Remediation items: [count requiring action]
- Recommended next scan: [date, quarterly minimum for Type II]

## MCP Tools Used
- `nuclei_auth_status` — Check nuclei installation
- `nuclei_scan` — Run vulnerability scan against target URLs
- `read_document` — Read scope config for targets
- `store_evidence` — Store scan results as evidence
- `map_evidence_to_control` — Link evidence to TSC controls
- `create_document` — Generate pentest report
- `get_control_coverage` — Check updated coverage after storing evidence
